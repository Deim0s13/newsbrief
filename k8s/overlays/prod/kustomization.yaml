apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

metadata:
  name: newsbrief-prod

namespace: newsbrief-prod

labels:
  - pairs:
      app.kubernetes.io/instance: prod
      environment: production
    includeSelectors: false

resources:
  - ../../base
  - pdb.yaml  # PodDisruptionBudget for HA
  - pvc.yaml  # Persistent storage for data

# Override namespace name for prod
patches:
  - target:
      kind: Namespace
      name: newsbrief
    patch: |
      - op: replace
        path: /metadata/name
        value: newsbrief-prod
  # Strategic merge patch for deployment (resources, probes, affinity)
  - path: deployment-patch.yaml
  # JSON patch to replace emptyDir with PVC (more reliable than strategic merge)
  - target:
      kind: Deployment
      name: newsbrief
    patch: |
      - op: replace
        path: /spec/template/spec/volumes
        value:
          - name: data
            persistentVolumeClaim:
              claimName: newsbrief-data

images:
  - name: localhost:5000/newsbrief
    # This will be updated by CI pipeline with semantic version
    newTag: v0.7.6-fix5

# Prod-specific configuration overrides
configMapGenerator:
  - name: newsbrief-config
    behavior: merge
    literals:
      - ENVIRONMENT=production
      - NEWSBRIEF_MAX_ITEMS_PER_REFRESH=200
      - NEWSBRIEF_MAX_ITEMS_PER_FEED=100
