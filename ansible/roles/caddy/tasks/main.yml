---
# Caddy role - ensures reverse proxy is running for newsbrief.local

- name: Check if Caddy container is running
  command: podman ps --filter name={{ caddy_container_name }} --format "{{ '{{' }}.Names{{ '}}' }}"
  register: caddy_running
  changed_when: false

- name: Get host IP for Podman networking
  shell: podman exec {{ caddy_container_name }} getent hosts host.containers.internal | awk '{print $1}'
  register: host_ip_existing
  when: caddy_running.stdout != ""
  failed_when: false
  changed_when: false

- name: Start temporary container to get host IP
  command: podman run --rm alpine getent hosts host.containers.internal
  register: host_ip_temp
  when: caddy_running.stdout == ""
  failed_when: false
  changed_when: false

- name: Set host IP fact
  set_fact:
    host_ip: "{{ host_ip_existing.stdout.split()[0] if host_ip_existing.stdout is defined and host_ip_existing.stdout else host_ip_temp.stdout.split()[0] if host_ip_temp.stdout is defined and host_ip_temp.stdout else '192.168.127.254' }}"

- name: Update Caddyfile with correct host IP
  copy:
    content: |
      # Caddy reverse proxy for NewsBrief (Kubernetes)
      # Auto-generated by Ansible - do not edit manually

      newsbrief.local {
          tls internal

          header {
              Strict-Transport-Security "max-age=31536000; includeSubDomains"
              X-Content-Type-Options "nosniff"
              X-Frame-Options "DENY"
              Referrer-Policy "strict-origin-when-cross-origin"
              -Server
          }

          reverse_proxy {{ host_ip }}:8788
      }
    dest: "{{ project_root }}/Caddyfile"
  register: caddyfile_updated

- name: Remove existing Caddy container
  command: podman rm -f {{ caddy_container_name }}
  when: caddy_running.stdout != "" and caddyfile_updated is changed
  failed_when: false

- name: Ensure Caddy data directories exist
  file:
    path: "{{ project_root }}/caddy-data/{{ item }}"
    state: directory
  loop:
    - data
    - config

- name: Start Caddy container
  command: >
    podman run -d
    --name {{ caddy_container_name }}
    -p 80:80
    -p 443:443
    -v {{ project_root }}/Caddyfile:/etc/caddy/Caddyfile:ro
    -v {{ project_root }}/caddy-data/data:/data
    -v {{ project_root }}/caddy-data/config:/config
    caddy:2-alpine
  when: caddy_running.stdout == "" or caddyfile_updated is changed

- name: Wait for Caddy to start
  pause:
    seconds: 3
  when: caddy_running.stdout == "" or caddyfile_updated is changed

- name: Verify Caddy is running
  command: podman ps --filter name={{ caddy_container_name }} --format "{{ '{{' }}.Status{{ '}}' }}"
  register: caddy_status
  changed_when: false

- name: Display Caddy status
  debug:
    msg: "âœ… Caddy reverse proxy is running ({{ caddy_status.stdout }})"
