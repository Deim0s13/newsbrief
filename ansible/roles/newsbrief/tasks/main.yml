---
# NewsBrief role - ensures prod is running in Kubernetes
# Dev runs locally via 'make dev' (not containerized)

- name: Wait for prod deployment to be ready
  command: kubectl wait --for=condition=available deployment/newsbrief -n {{ prod_namespace }} --timeout=120s
  changed_when: false
  retries: 3
  delay: 10

# Port Forwards (prod only - dev is local)
- name: Kill existing kubectl port forwards
  shell: pkill -f "kubectl port-forward" || true
  changed_when: false

- name: Start prod port forward (8788)
  shell: nohup kubectl port-forward svc/newsbrief -n {{ prod_namespace }} 8788:8787 > /dev/null 2>&1 &
  async: 10
  poll: 0

- name: Start event listener port forward (8080)
  shell: nohup kubectl port-forward svc/el-newsbrief-listener 8080:8080 > /dev/null 2>&1 &
  async: 10
  poll: 0

- name: Start Tekton dashboard port forward (9097)
  shell: nohup kubectl port-forward svc/tekton-dashboard -n tekton-pipelines 9097:9097 > /dev/null 2>&1 &
  async: 10
  poll: 0

- name: Wait for port forwards to establish
  pause:
    seconds: 3

- name: Verify prod is accessible
  uri:
    url: http://localhost:8788/healthz
    return_content: true
  register: prod_health
  retries: 3
  delay: 2

- name: Display NewsBrief status
  debug:
    msg: |
      ✅ NewsBrief prod is running in Kubernetes

      Dev:  Run 'make dev' locally → http://localhost:8787
      Prod: Kubernetes → https://newsbrief.local (or http://localhost:8788)
