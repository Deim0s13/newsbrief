{% extends "base.html" %}

{% block title %}{{ article.title or "Article" }} - NewsBrief{% endblock %}

{% block head %}
<style>
    .skim-mode .article-full-content {
        display: none !important;
    }
    .skim-mode .article-summary-only {
        display: block !important;
    }
    .detail-mode .article-summary-only {
        display: none !important;
    }
    .detail-mode .article-full-content {
        display: block !important;
    }
    .article-content img {
        max-width: 100%;
        height: auto;
        border-radius: 0.5rem;
        margin: 1rem 0;
    }
    .article-content h1, .article-content h2, .article-content h3 {
        margin-top: 2rem;
        margin-bottom: 1rem;
        font-weight: 600;
    }
    .article-content p {
        margin-bottom: 1rem;
        line-height: 1.7;
    }
    .article-content ul, .article-content ol {
        margin: 1rem 0;
        padding-left: 2rem;
    }
    .article-content li {
        margin-bottom: 0.5rem;
    }
    .article-content blockquote {
        border-left: 4px solid #3b82f6;
        padding-left: 1rem;
        margin: 1rem 0;
        font-style: italic;
        color: #6b7280;
    }
    .article-content code {
        background-color: #f3f4f6;
        padding: 0.125rem 0.25rem;
        border-radius: 0.25rem;
        font-size: 0.875em;
    }
    .article-content pre {
        background-color: #1f2937;
        color: #f9fafb;
        padding: 1rem;
        border-radius: 0.5rem;
        overflow-x: auto;
        margin: 1rem 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8" id="article-container">
    <!-- Back Navigation -->
    <div class="mb-6">
        <a href="/" class="inline-flex items-center text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300">
            <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            Back to Articles
        </a>
    </div>

    <!-- Article Header -->
    <header class="mb-8">
        <!-- Topic and Metadata -->
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center space-x-3">
                {% if article.topic %}
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium topic-badge-{{ article.topic }}">
                    {{ article.topic|replace('ai-ml', 'AI/ML')|replace('cloud-k8s', 'Cloud/K8s')|replace('devtools', 'DevTools')|replace('chips-hardware', 'Chips/Hardware')|replace('politics', 'Politics')|replace('business', 'Business')|replace('science', 'Science')|replace('general', 'General')|title }}
                </span>
                {% endif %}
                {% if article.ranking_score %}
                <span class="text-xs text-gray-500 dark:text-gray-400 font-mono">
                    Score: {{ "%.3f"|format(article.ranking_score) }}
                </span>
                {% endif %}
            </div>

            <!-- View Toggle -->
            <div class="flex items-center space-x-2">
                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">View:</span>
                <div class="flex bg-gray-100 dark:bg-gray-700 rounded-lg p-1">
                    <button id="skim-btn" class="px-3 py-1 text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white rounded-md" onclick="setViewMode('skim')">
                        Skim
                    </button>
                    <button id="detail-btn" class="px-3 py-1 text-sm font-medium bg-white dark:bg-gray-600 text-gray-900 dark:text-white shadow-sm rounded-md" onclick="setViewMode('detail')">
                        Detail
                    </button>
                </div>
            </div>
        </div>

        <!-- Title -->
        <h1 class="text-4xl font-bold text-gray-900 dark:text-white leading-tight mb-4">
            {{ article.title or "Untitled Article" }}
        </h1>

        <!-- Article Metadata -->
        <div class="flex flex-wrap items-center gap-4 text-sm text-gray-500 dark:text-gray-400 mb-6">
            {% if article.published %}
            <div class="flex items-center">
                <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                <time class="article-published-date" data-timestamp="{{ article.published.isoformat() if article.published else '' }}">
                    {{ article.published.strftime('%d %b %Y') if article.published else 'No date' }}
                </time>
            </div>
            {% endif %}

            {% if article.author %}
            <div class="flex items-center">
                <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
                <span>{{ article.author }}</span>
            </div>
            {% endif %}

            <div class="flex items-center">
                <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                </svg>
                <a href="{{ article.url }}" target="_blank" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300">
                    Read Original
                </a>
            </div>

            <!-- Source Credibility Badge (Issue #197) -->
            <div class="flex items-center">
                <span id="source-credibility-badge" class="credibility-badge" data-url="{{ article.url }}"></span>
            </div>
        </div>
    </header>

    <!-- Article Content -->
    <main class="prose prose-lg dark:prose-invert max-w-none">
        <!-- AI Summary (Skim Mode) -->
        <div class="article-summary-only mb-8">
            {% if article.structured_summary %}
            <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-6 mb-6">
                <div class="flex items-center mb-4">
                    <svg class="h-5 w-5 text-blue-600 dark:text-blue-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                    <h2 class="text-lg font-semibold text-blue-900 dark:text-blue-100">AI Summary</h2>
                    {% if article.structured_summary.is_chunked %}
                    <span class="ml-2 text-xs px-2 py-1 bg-blue-200 text-blue-800 dark:bg-blue-800 dark:text-blue-200 rounded-full">
                        Chunked ({{ article.structured_summary.chunk_count }} parts)
                    </span>
                    {% endif %}
                </div>

                {% if article.structured_summary.bullets %}
                <div class="mb-4">
                    <h3 class="font-medium text-gray-900 dark:text-white mb-2">Key Points:</h3>
                    <ul class="space-y-2">
                        {% for bullet in article.structured_summary.bullets %}
                        <li class="flex items-start">
                            <svg class="h-2 w-2 text-blue-600 dark:text-blue-400 mt-2 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 8 8">
                                <circle cx="4" cy="4" r="4"/>
                            </svg>
                            <span class="text-gray-700 dark:text-gray-300">{{ bullet }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                {% if article.structured_summary.why_it_matters %}
                <div class="mb-4">
                    <h3 class="font-medium text-gray-900 dark:text-white mb-2">Why it matters:</h3>
                    <p class="text-gray-700 dark:text-gray-300">{{ article.structured_summary.why_it_matters }}</p>
                </div>
                {% endif %}

                {% if article.structured_summary.tags %}
                <div>
                    <h3 class="font-medium text-gray-900 dark:text-white mb-2">Tags:</h3>
                    <div class="flex flex-wrap gap-2">
                        {% for tag in article.structured_summary.tags %}
                        <span class="px-2 py-1 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-sm rounded-full">
                            {{ tag }}
                        </span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
            {% elif article.ai_summary %}
            <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-6 mb-6">
                <div class="flex items-center mb-4">
                    <svg class="h-5 w-5 text-blue-600 dark:text-blue-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                    <h2 class="text-lg font-semibold text-blue-900 dark:text-blue-100">AI Summary</h2>
                </div>
                <p class="text-gray-700 dark:text-gray-300">{{ article.ai_summary }}</p>
            </div>
            {% elif article.fallback_summary %}
            <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6 mb-6">
                <div class="flex items-center mb-4">
                    <svg class="h-5 w-5 text-gray-600 dark:text-gray-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Quick Summary</h2>
                </div>
                <p class="text-gray-700 dark:text-gray-300">{{ article.fallback_summary }}</p>
            </div>
            {% elif article.summary %}
            <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6 mb-6">
                <div class="flex items-center mb-4">
                    <svg class="h-5 w-5 text-gray-600 dark:text-gray-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Article Summary</h2>
                </div>
                <p class="text-gray-700 dark:text-gray-300">{{ article.summary }}</p>
            </div>
            {% endif %}
        </div>

        <!-- Full Article Content (Detail Mode) -->
        <div class="article-full-content">
            {% if article.content %}
            <div class="article-content text-gray-900 dark:text-gray-100">
                {{ article.content|safe }}
            </div>
            {% else %}
            <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                <p>Full article content is not available.</p>
                <a href="{{ article.url }}" target="_blank" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 mt-2 inline-block">
                    Read the original article â†’
                </a>
            </div>
            {% endif %}
        </div>
    </main>

    <!-- Article Actions -->
    <footer class="mt-12 pt-8 border-t border-gray-200 dark:border-gray-700">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <a href="{{ article.url }}" target="_blank" class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-md">
                    <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                    </svg>
                    Read Original
                </a>

                <button onclick="shareArticle()" class="inline-flex items-center px-4 py-2 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 text-sm font-medium rounded-md">
                    <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path>
                    </svg>
                    Share
                </button>
            </div>

            <div class="text-sm text-gray-500 dark:text-gray-400">
                {% if article.ai_generated_at %}
                AI Summary generated {{ article.ai_generated_at if article.ai_generated_at else 'recently' }}
                {% endif %}
            </div>
        </div>
    </footer>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', path='js/credibility.js') }}"></script>
<script>
let currentViewMode = 'detail';

function setViewMode(mode) {
    currentViewMode = mode;
    const container = document.getElementById('article-container');
    const skimBtn = document.getElementById('skim-btn');
    const detailBtn = document.getElementById('detail-btn');

    // Remove all mode classes
    container.classList.remove('skim-mode', 'detail-mode');

    // Add the selected mode class
    container.classList.add(mode + '-mode');

    // Update button states
    if (mode === 'skim') {
        skimBtn.className = 'px-3 py-1 text-sm font-medium bg-white dark:bg-gray-600 text-gray-900 dark:text-white shadow-sm rounded-md';
        detailBtn.className = 'px-3 py-1 text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white rounded-md';
    } else {
        detailBtn.className = 'px-3 py-1 text-sm font-medium bg-white dark:bg-gray-600 text-gray-900 dark:text-white shadow-sm rounded-md';
        skimBtn.className = 'px-3 py-1 text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white rounded-md';
    }

    console.log('View mode changed to:', mode);
    console.log('Container classes:', container.className);
}

function shareArticle() {
    const title = "{{ article.title or 'Article' }}";
    const url = window.location.href;

    if (navigator.share) {
        navigator.share({
            title: title,
            url: url
        });
    } else {
        // Fallback: copy to clipboard
        navigator.clipboard.writeText(url).then(() => {
            // Show notification
            showNotification('Article link copied to clipboard', 'success');
        });
    }
}

// Simple notification function (from main app.js)
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-4 py-2 rounded-md text-white text-sm font-medium z-50 ${
        type === 'success' ? 'bg-green-500' :
        type === 'error' ? 'bg-red-500' :
        'bg-blue-500'
    }`;
    notification.textContent = message;

    document.body.appendChild(notification);

    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Initialize detail mode on load
document.addEventListener('DOMContentLoaded', function() {
    console.log('Article detail page loaded, initializing detail mode');
    console.log('Container element found:', document.getElementById('article-container'));
    console.log('Skim button found:', document.getElementById('skim-btn'));
    console.log('Detail button found:', document.getElementById('detail-btn'));
    setViewMode('detail');

    // Format dates using DateUtils for locale-aware display
    document.querySelectorAll('.article-published-date').forEach(function(el) {
        const timestamp = el.getAttribute('data-timestamp');
        if (timestamp) {
            el.textContent = DateUtils.formatMediumDate(timestamp);
            el.title = DateUtils.formatDateTime(timestamp);
        }
    });

    // Load source credibility badge (Issue #197)
    loadSourceCredibility();
});

// Load credibility badge for article source
async function loadSourceCredibility() {
    const badge = document.getElementById('source-credibility-badge');
    if (!badge) return;

    const url = badge.getAttribute('data-url');
    if (!url) return;

    // Show loading state
    badge.innerHTML = CredibilityUtils.renderLoading();

    const domain = CredibilityUtils.extractDomain(url);
    if (!domain) return;

    const credData = await CredibilityUtils.fetchCredibility([domain]);
    const cred = credData[domain];

    // Use detailed badge for article view (shows "Not Rated" if not found)
    if (cred) {
        badge.innerHTML = CredibilityUtils.renderDetailedBadge(cred);
    } else {
        badge.innerHTML = CredibilityUtils.renderNotRated();
    }
}
</script>

<style>
/* Topic badge colors */
.topic-badge-ai-ml { @apply bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200; }
.topic-badge-cloud-k8s { @apply bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200; }
.topic-badge-security { @apply bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200; }
.topic-badge-devtools { @apply bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200; }
.topic-badge-chips-hardware { @apply bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200; }
</style>
{% endblock %}
