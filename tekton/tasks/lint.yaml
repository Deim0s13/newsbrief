# Tekton Task: Lint
# Checks code formatting with black and isort
#
# Usage:
#   tkn task start lint --workspace name=source,claimName=source-pvc --showlog
#
# Failure Notification:
#   Currently: Check via `tkn taskrun list` or `--showlog`
#   Future: Webhook notifications (see Issue #156)

apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: lint
  labels:
    app.kubernetes.io/part-of: newsbrief
spec:
  description: Check Python code formatting with black and isort
  workspaces:
    - name: source
      description: The source code to lint
  params:
    - name: paths
      type: string
      default: "app/ tests/"
      description: Space-separated paths to lint
  steps:
    - name: black
      image: python:3.11-slim
      workingDir: $(workspaces.source.path)
      script: |
        #!/usr/bin/env bash
        set -e
        pip install 'black>=24.0.0' --quiet
        echo "üîç Checking code formatting with black..."
        black --check --diff $(params.paths) || {
          echo "‚ö†Ô∏è  Formatting issues found. Auto-formatting..."
          black $(params.paths)
          echo "‚úÖ Files formatted (non-blocking)"
          exit 0
        }
        echo "‚úÖ black check passed"

    - name: isort
      image: python:3.11-slim
      workingDir: $(workspaces.source.path)
      script: |
        #!/usr/bin/env bash
        set -e
        pip install isort --quiet
        echo "üîç Checking import order with isort..."
        isort --check-only --diff --profile=black $(params.paths) || {
          echo "‚ö†Ô∏è  Import order issues found. Auto-formatting..."
          isort --profile=black $(params.paths)
          echo "‚úÖ Imports sorted (non-blocking)"
          exit 0
        }
        echo "‚úÖ isort check passed"
