apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: create-release
  labels:
    app.kubernetes.io/part-of: newsbrief
spec:
  description: |
    Creates a Git tag and GitHub release after successful CI pipeline.
    Extracts version from pyproject.toml and creates release with auto-generated notes.
  params:
    - name: repo-url
      type: string
      description: The Git repository URL
    - name: revision
      type: string
      description: The Git commit SHA to tag
    - name: repo-owner
      type: string
      description: GitHub repository owner
      default: "Deim0s13"
    - name: repo-name
      type: string
      description: GitHub repository name
      default: "newsbrief"
  workspaces:
    - name: source
      description: Workspace containing the cloned repository
  results:
    - name: version
      description: The version that was released
    - name: release-url
      description: URL to the GitHub release
  steps:
    - name: extract-version
      image: python:3.11-slim
      script: |
        #!/usr/bin/env python3
        import re

        with open("$(workspaces.source.path)/pyproject.toml", "r") as f:
            content = f.read()

        match = re.search(r'version\s*=\s*"([^"]+)"', content)
        if match:
            version = f"v{match.group(1)}"
            print(f"Extracted version: {version}")
            with open("$(results.version.path)", "w") as f:
                f.write(version)
        else:
            print("ERROR: Could not extract version from pyproject.toml")
            exit(1)

    - name: create-tag-and-release
      image: curlimages/curl:latest
      env:
        - name: GITHUB_TOKEN
          valueFrom:
            secretKeyRef:
              name: github-release-token
              key: token
        - name: REPO_OWNER
          value: "$(params.repo-owner)"
        - name: REPO_NAME
          value: "$(params.repo-name)"
        - name: REVISION
          value: "$(params.revision)"
      script: |
        #!/bin/sh
        set -e

        VERSION=$(cat $(results.version.path))
        echo "ðŸš€ Creating release for version: $VERSION"

        API_URL="https://api.github.com/repos/$REPO_OWNER/$REPO_NAME"

        # Check if release already exists
        EXISTING=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
          "$API_URL/releases/tags/$VERSION" | grep -o '"html_url"' || true)

        if [ -n "$EXISTING" ]; then
          echo "Release $VERSION already exists, skipping..."
          RELEASE_URL=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "$API_URL/releases/tags/$VERSION" | grep -o '"html_url": "[^"]*"' | head -1 | cut -d'"' -f4)
          echo "$RELEASE_URL" > $(results.release-url.path)
          exit 0
        fi

        # Create the release via GitHub API
        echo "Creating GitHub release $VERSION..."
        RESPONSE=$(curl -s -X POST \
          -H "Authorization: token $GITHUB_TOKEN" \
          -H "Accept: application/vnd.github.v3+json" \
          "$API_URL/releases" \
          -d "{
            \"tag_name\": \"$VERSION\",
            \"target_commitish\": \"$REVISION\",
            \"name\": \"$VERSION\",
            \"body\": \"## NewsBrief $VERSION\\n\\nAutomated release from CI pipeline.\",
            \"draft\": false,
            \"prerelease\": false,
            \"generate_release_notes\": true
          }")

        # Extract the release URL
        RELEASE_URL=$(echo "$RESPONSE" | grep -o '"html_url": "[^"]*"' | head -1 | cut -d'"' -f4)

        if [ -z "$RELEASE_URL" ]; then
          echo "âŒ Failed to create release:"
          echo "$RESPONSE"
          exit 1
        fi

        echo "$RELEASE_URL" > $(results.release-url.path)
        echo "âœ… Release created: $RELEASE_URL"
