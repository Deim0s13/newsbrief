apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: cleanup-branches
  labels:
    app.kubernetes.io/part-of: newsbrief
spec:
  description: |
    Cleans up merged feature branches from GitHub.
    Deletes branches that have been merged and are older than specified days.
  params:
    - name: REPO_OWNER
      type: string
      default: "Deim0s13"
    - name: REPO_NAME
      type: string
      default: "newsbrief"
    - name: DAYS_OLD
      type: string
      default: "7"
      description: Delete merged branches older than this many days
    - name: DRY_RUN
      type: string
      default: "false"
      description: If true, only report what would be deleted
    - name: PROTECTED_BRANCHES
      type: string
      default: "main,dev"
      description: Comma-separated list of branches to never delete
  results:
    - name: DELETED_COUNT
      description: Number of branches deleted
  steps:
    - name: cleanup
      image: ghcr.io/cli/cli:latest
      env:
        - name: GITHUB_TOKEN
          valueFrom:
            secretKeyRef:
              name: github-release-token
              key: token
        - name: REPO_OWNER
          value: "$(params.REPO_OWNER)"
        - name: REPO_NAME
          value: "$(params.REPO_NAME)"
        - name: DAYS_OLD
          value: "$(params.DAYS_OLD)"
        - name: DRY_RUN
          value: "$(params.DRY_RUN)"
        - name: PROTECTED
          value: "$(params.PROTECTED_BRANCHES)"
      script: |
        #!/bin/sh
        set -e

        echo "ðŸ§¹ Cleaning up merged branches from $REPO_OWNER/$REPO_NAME"
        echo "   Older than: $DAYS_OLD days"
        echo "   Protected: $PROTECTED"
        echo "   Dry run: $DRY_RUN"
        echo ""

        # Calculate cutoff date
        CUTOFF_DATE=$(date -d "-${DAYS_OLD} days" +%Y-%m-%d 2>/dev/null || date -v-${DAYS_OLD}d +%Y-%m-%d)
        echo "Cutoff date: $CUTOFF_DATE"

        # Get list of branches
        BRANCHES=$(gh api repos/$REPO_OWNER/$REPO_NAME/branches --paginate -q '.[].name')

        DELETE_COUNT=0

        for branch in $BRANCHES; do
          # Skip protected branches
          if echo ",$PROTECTED," | grep -q ",$branch,"; then
            echo "â­ï¸  Skipping protected branch: $branch"
            continue
          fi

          # Check if branch is merged into main or dev
          MERGED=$(gh api repos/$REPO_OWNER/$REPO_NAME/compare/main...$branch -q '.status' 2>/dev/null || echo "diverged")

          if [ "$MERGED" = "identical" ] || [ "$MERGED" = "behind" ]; then
            # Get last commit date
            LAST_COMMIT=$(gh api repos/$REPO_OWNER/$REPO_NAME/branches/$branch -q '.commit.commit.committer.date' | cut -d'T' -f1)

            if [ "$LAST_COMMIT" \< "$CUTOFF_DATE" ]; then
              if [ "$DRY_RUN" = "true" ]; then
                echo "ðŸ” Would delete: $branch (last commit: $LAST_COMMIT)"
              else
                echo "ðŸ—‘ï¸  Deleting: $branch (last commit: $LAST_COMMIT)"
                gh api -X DELETE repos/$REPO_OWNER/$REPO_NAME/git/refs/heads/$branch || echo "   Warning: Failed to delete $branch"
              fi
              DELETE_COUNT=$((DELETE_COUNT + 1))
            fi
          fi
        done

        echo ""
        if [ "$DRY_RUN" = "true" ]; then
          echo "âœ… Would delete $DELETE_COUNT branches (dry run)"
        else
          echo "âœ… Deleted $DELETE_COUNT branches"
        fi

        echo -n "$DELETE_COUNT" > $(results.DELETED_COUNT.path)
