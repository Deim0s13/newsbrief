apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: update-manifest
spec:
  description: Update Kustomize overlay with new image tag and commit to Git
  workspaces:
    - name: source
      description: Workspace containing the Git repository
  params:
    - name: IMAGE_TAG
      type: string
      description: The new image tag to set
    - name: ENVIRONMENT
      type: string
      description: Target environment (dev or prod)
      default: "dev"
    - name: GIT_USER_NAME
      type: string
      default: "Tekton CI"
    - name: GIT_USER_EMAIL
      type: string
      default: "tekton@newsbrief.local"
  results:
    - name: COMMIT_SHA
      description: The commit SHA of the manifest update
  steps:
    - name: verify-kustomization
      image: alpine:latest
      workingDir: $(workspaces.source.path)
      script: |
        #!/bin/sh
        set -eu

        OVERLAY_PATH="k8s/overlays/$(params.ENVIRONMENT)/kustomization.yaml"

        echo "ðŸ“ Will update $OVERLAY_PATH with tag: $(params.IMAGE_TAG)"

        # Check if file exists
        if [ ! -f "$OVERLAY_PATH" ]; then
          echo "âŒ Error: $OVERLAY_PATH not found"
          exit 1
        fi

        echo "âœ… Kustomization file found"
        cat "$OVERLAY_PATH"

    - name: commit-and-push
      image: alpine/git:latest
      env:
        - name: GITHUB_TOKEN
          valueFrom:
            secretKeyRef:
              name: github-release-token
              key: token
        - name: WORKSPACE_PATH
          value: "$(workspaces.source.path)"
      script: |
        #!/bin/sh
        set -eu

        # Ensure we're in the workspace
        cd "$WORKSPACE_PATH"
        echo "Working directory: $(pwd)"

        # Mark directory as safe (needed for different user ownership)
        git config --global --add safe.directory "$WORKSPACE_PATH"

        # Configure Git
        git config user.name "$(params.GIT_USER_NAME)"
        git config user.email "$(params.GIT_USER_EMAIL)"

        # Determine target branch
        TARGET_BRANCH=$(params.ENVIRONMENT)
        if [ "$TARGET_BRANCH" = "prod" ]; then
          TARGET_BRANCH="main"
        fi

        # Configure remote with token for push (token masked from logs)
        REPO_URL=$(git remote get-url origin)
        AUTH_URL=$(echo "$REPO_URL" | sed "s|https://|https://${GITHUB_TOKEN}@|")
        git remote set-url origin "$AUTH_URL" 2>/dev/null

        # Fetch and checkout target branch
        echo "ðŸ“¥ Fetching $TARGET_BRANCH..."
        git fetch origin $TARGET_BRANCH 2>&1 | grep -v "$GITHUB_TOKEN" || true
        git checkout -B $TARGET_BRANCH origin/$TARGET_BRANCH 2>&1 | grep -v "$GITHUB_TOKEN" || true

        # Apply the kustomization change to the target branch
        sed -i "s/newTag: .*/newTag: $(params.IMAGE_TAG)/" k8s/overlays/$(params.ENVIRONMENT)/kustomization.yaml

        # Check for changes
        if git diff --quiet k8s/overlays/$(params.ENVIRONMENT)/kustomization.yaml; then
          echo "â„¹ï¸  No changes to commit"
          echo -n "no-change" > $(results.COMMIT_SHA.path)
          exit 0
        fi

        # Stage and commit
        git add k8s/overlays/$(params.ENVIRONMENT)/kustomization.yaml
        git commit -m "ci: update $(params.ENVIRONMENT) image to $(params.IMAGE_TAG)

        Automated by Tekton CI pipeline"

        # Get commit SHA
        COMMIT=$(git rev-parse HEAD)
        echo -n "$COMMIT" > $(results.COMMIT_SHA.path)

        echo "âœ… Committed: $COMMIT"

        # Push to the target branch (mask token from any error output)
        echo "ðŸ“¤ Pushing to $TARGET_BRANCH..."
        git push origin $TARGET_BRANCH 2>&1 | sed "s/$GITHUB_TOKEN/[MASKED]/g"

        echo "âœ… Pushed manifest update to $TARGET_BRANCH"
