# Tekton Task: Run Python tests
#
# Runs:
#   1. Wait for PostgreSQL sidecar
#   2. Run Alembic migrations
#   3. pytest with coverage
#   4. mypy type checking (non-blocking)
#
# Uses PostgreSQL sidecar for database tests (ADR 0022)

apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: test
  labels:
    app.kubernetes.io/part-of: newsbrief
spec:
  description: Run pytest and mypy on Python code with PostgreSQL
  workspaces:
    - name: source
      description: The source code to test
  params:
    - name: test-paths
      type: string
      default: "tests/"
      description: Paths to test
    - name: coverage-source
      type: string
      default: "app"
      description: Source directory for coverage
    - name: coverage-fail-under
      type: string
      default: "34"
      description: Minimum coverage percentage
  results:
    - name: tests-passed
      description: Whether tests passed
    - name: coverage-percent
      description: Coverage percentage achieved
  sidecars:
    - name: postgres
      image: postgres:16
      env:
        - name: POSTGRES_USER
          value: test
        - name: POSTGRES_PASSWORD
          value: test
        - name: POSTGRES_DB
          value: newsbrief_test
      readinessProbe:
        exec:
          command: ["pg_isready", "-U", "test", "-d", "newsbrief_test"]
        periodSeconds: 2
        initialDelaySeconds: 2
  steps:
    - name: wait-for-postgres
      image: postgres:16
      script: |
        #!/usr/bin/env bash
        set -e
        echo "‚è≥ Waiting for PostgreSQL to be ready..."
        until pg_isready -h localhost -U test -d newsbrief_test; do
          sleep 1
        done
        echo "‚úÖ PostgreSQL is ready"

    - name: install-deps-and-migrate
      image: python:3.11-slim
      workingDir: $(workspaces.source.path)
      env:
        - name: DATABASE_URL
          value: "postgresql://test:test@localhost:5432/newsbrief_test"
      script: |
        #!/usr/bin/env bash
        set -e
        echo "üì¶ Installing dependencies..."
        pip install --quiet --upgrade pip
        pip install --quiet -r requirements.txt
        pip install --quiet pytest pytest-asyncio pytest-cov mypy alembic
        echo "‚úÖ Dependencies installed"

        echo "üîÑ Running Alembic migrations..."
        alembic upgrade head
        echo "‚úÖ Database schema ready"

    - name: pytest
      image: python:3.11-slim
      workingDir: $(workspaces.source.path)
      env:
        - name: CI
          value: "true"
        - name: DATABASE_URL
          value: "postgresql://test:test@localhost:5432/newsbrief_test"
      script: |
        #!/usr/bin/env bash
        set -e

        # Reinstall deps (each step is a fresh container)
        pip install --quiet -r requirements.txt pytest pytest-asyncio pytest-cov >/dev/null 2>&1

        echo "üß™ Running pytest with coverage..."
        pytest $(params.test-paths) \
          --cov=$(params.coverage-source) \
          --cov-report=term \
          --cov-fail-under=$(params.coverage-fail-under) \
          -v --tb=short

        echo "true" | tee $(results.tests-passed.path)
        echo "‚úÖ All tests passed"

    - name: mypy
      image: python:3.11-slim
      workingDir: $(workspaces.source.path)
      env:
        - name: DATABASE_URL
          value: "postgresql://test:test@localhost:5432/newsbrief_test"
      script: |
        #!/usr/bin/env bash
        # mypy is non-blocking (continue-on-error)

        pip install --quiet -r requirements.txt mypy >/dev/null 2>&1

        echo "üîç Running mypy type checking..."
        if mypy app/ --ignore-missing-imports --no-strict-optional; then
          echo "‚úÖ mypy check passed"
        else
          echo "‚ö†Ô∏è  mypy found type issues (non-blocking)"
        fi

        # Always exit 0 - mypy is advisory
        exit 0
