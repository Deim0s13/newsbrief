# Tekton Task: Run Python tests
#
# Runs:
#   1. pytest with coverage
#   2. mypy type checking (non-blocking)
#
# Mirrors GitHub Actions test job behavior

apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: test
  labels:
    app.kubernetes.io/part-of: newsbrief
spec:
  description: Run pytest and mypy on Python code
  workspaces:
    - name: source
      description: The source code to test
  params:
    - name: test-paths
      type: string
      default: "tests/"
      description: Paths to test
    - name: coverage-source
      type: string
      default: "app"
      description: Source directory for coverage
    - name: coverage-fail-under
      type: string
      default: "35"
      description: Minimum coverage percentage
  results:
    - name: tests-passed
      description: Whether tests passed
    - name: coverage-percent
      description: Coverage percentage achieved
  steps:
    - name: install-deps
      image: python:3.11-slim
      workingDir: $(workspaces.source.path)
      script: |
        #!/usr/bin/env bash
        set -e
        echo "üì¶ Installing dependencies..."
        pip install --quiet --upgrade pip
        pip install --quiet -r requirements.txt
        pip install --quiet pytest pytest-asyncio pytest-cov mypy
        echo "‚úÖ Dependencies installed"

    - name: pytest
      image: python:3.11-slim
      workingDir: $(workspaces.source.path)
      env:
        - name: CI
          value: "true"
      script: |
        #!/usr/bin/env bash
        set -e

        # Reinstall deps (each step is a fresh container)
        pip install --quiet -r requirements.txt pytest pytest-asyncio pytest-cov >/dev/null 2>&1

        echo "üß™ Running pytest with coverage..."
        pytest $(params.test-paths) \
          --cov=$(params.coverage-source) \
          --cov-report=term \
          --cov-fail-under=$(params.coverage-fail-under) \
          -v --tb=short

        echo "true" | tee $(results.tests-passed.path)
        echo "‚úÖ All tests passed"

    - name: mypy
      image: python:3.11-slim
      workingDir: $(workspaces.source.path)
      script: |
        #!/usr/bin/env bash
        # mypy is non-blocking (continue-on-error)

        pip install --quiet -r requirements.txt mypy >/dev/null 2>&1

        echo "üîç Running mypy type checking..."
        if mypy app/ --ignore-missing-imports --no-strict-optional; then
          echo "‚úÖ mypy check passed"
        else
          echo "‚ö†Ô∏è  mypy found type issues (non-blocking)"
        fi

        # Always exit 0 - mypy is advisory
        exit 0
