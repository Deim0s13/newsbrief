# CI Pipeline for Development
# Triggered on merge to dev branch
#
# Purpose: Quality gates only (dev runs locally via `make dev`)
#
# Stages:
#   1. fetch-source - Clone repository
#   2. lint + test  - Run in parallel (fast feedback)
#
# Per ADR-0019: CI/CD Pipeline Design
# Note: No image build - dev environment runs locally, not containerized

apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: ci-dev
  labels:
    app.kubernetes.io/part-of: newsbrief
    newsbrief.dev/environment: development
spec:
  description: Development CI pipeline - lint and test only (dev runs locally)
  workspaces:
    - name: source
      description: Source code workspace
  params:
    - name: repo-url
      type: string
      default: "https://github.com/Deim0s13/newsbrief.git"
      description: Git repository URL
    - name: revision
      type: string
      default: "dev"
      description: Git branch or tag to checkout

  tasks:
    # ══════════════════════════════════════════════════════════════
    # Stage 1: Fetch Source
    # ══════════════════════════════════════════════════════════════
    - name: fetch-source
      taskRef:
        name: git-clone
      workspaces:
        - name: output
          workspace: source
      params:
        - name: url
          value: $(params.repo-url)
        - name: revision
          value: $(params.revision)

    # ══════════════════════════════════════════════════════════════
    # Stage 2: Quality Gates (parallel)
    # ══════════════════════════════════════════════════════════════
    - name: lint
      taskRef:
        name: lint
      runAfter:
        - fetch-source
      workspaces:
        - name: source
          workspace: source

    - name: test
      taskRef:
        name: test
      runAfter:
        - fetch-source
      workspaces:
        - name: source
          workspace: source

  # ══════════════════════════════════════════════════════════════
  # Finally: Notifications (runs regardless of success/failure)
  # ══════════════════════════════════════════════════════════════
  finally:
    - name: notify-failure
      when:
        - input: $(tasks.status)
          operator: in
          values: ["Failed"]
      taskRef:
        name: notify-ntfy
      params:
        - name: topic
          value: "newsbrief-ci"
        - name: title
          value: "❌ Dev Pipeline Failed"
        - name: message
          value: "ci-dev failed on $(params.revision)"
        - name: priority
          value: "high"
        - name: tags
          value: "x,pipeline,dev"

    - name: notify-success
      when:
        - input: $(tasks.status)
          operator: in
          values: ["Succeeded"]
      taskRef:
        name: notify-ntfy
      params:
        - name: topic
          value: "newsbrief-ci"
        - name: title
          value: "✅ Dev Pipeline Succeeded"
        - name: message
          value: "ci-dev completed on $(params.revision)"
        - name: priority
          value: "default"
        - name: tags
          value: "white_check_mark,pipeline,dev"

    # Slack (disabled by default - enable by creating slack-webhook secret)
    - name: notify-slack
      taskRef:
        name: notify-slack
      params:
        - name: pipeline-name
          value: "ci-dev"
        - name: pipeline-run
          value: "$(context.pipelineRun.name)"
        - name: status
          value: "$(tasks.status)"
        - name: git-revision
          value: "$(params.revision)"
        - name: environment
          value: "dev"
